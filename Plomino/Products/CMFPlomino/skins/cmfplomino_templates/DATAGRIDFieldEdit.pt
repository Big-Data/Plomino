<tal:block tal:define="fieldname python:options['fieldname'];
                       v options/fieldvalue;
                       datatable_api here/REQUEST/datatable_api|nothing;">
<input type='hidden' tal:attributes="id string:${fieldname}_gridvalue;
                                     name fieldname;
                                     value v" />
        <script tal:condition="not:datatable_api" type="text/javascript" language="javascript" src="jquery-v1.4.2.js"></script>
        <script tal:condition="not:datatable_api" type="text/javascript" language="javascript" src="jquery.dataTables.js"></script>
        <script tal:condition="not:datatable_api" type="text/javascript" language="javascript" src="jquery.jeditable.js"></script>
        <style tal:condition="not:datatable_api" >
tr.datagrid_row_selected td {
    background-color: #B0BED9;
}
        </style>
        <script tal:condition="not:datatable_api" type="text/javascript" language="javascript">
        /* Get the rows which are currently selected */
            function fnGetSelected( oTableLocal )
            {
                var aReturn = new Array();
                var aTrs = oTableLocal.fnGetNodes();
                
                for ( var i=0 ; i<aTrs.length ; i++ )
                {
                    if ( $(aTrs[i]).hasClass('datagrid_row_selected') )
                    {
                        aReturn.push( aTrs[i] );
                    }
                }
                return aReturn;
            }
            function fnClickAddRow(table, field_id) {
                len = table.fnSettings().aoColumns.length
                newrow = new Array();
                for(i=0;i<len;i++) {
                    newrow[i]='';
                }
                table.fnAddData( newrow );
                make_editable(table, field_id);
            }
	        function fnDeleteAndUpdate(table, field_id) {
	            var anSelected=fnGetSelected(table);
	            table.fnDeleteRow(anSelected[0], function(){}, true);
	            save(table, field_id);
	        }
	
	        function save(table, field_id) {
	            data = table.fnGetData();
	            csv="";
	            $(data).each(function(row) {
	                r=data[row];
	                if(typeof r!="undefined" && r!=null) {
	                    csv=csv+r.join('\t')+'\n';
	                }
	               });
	            document.getElementById(field_id+'_gridvalue').value=csv;
	        }
	        function make_editable(table, field_id) {
	            $('#'+field_id+'_datagrid tbody td').editable( function(value, settings){
	                aPos = table.fnGetPosition( this );
	                table.fnUpdate( value, aPos[0], aPos[1] );
	                save(table, field_id);
	                return value;
	            }, {
	                tooltip   : "Doubleclick to edit...",
	                event     : "dblclick",
	            });
	        }

	        function make_selectable(table, field_id) {
	            $("#"+field_id+"_datagrid").click(function(event) {
	                $(table.fnSettings().aoData).each(function (){
	                    $(this.nTr).removeClass('datagrid_row_selected');
	                });
	                $(event.target.parentNode).addClass('datagrid_row_selected');
	            });
	        }
        </script>
        <script type="text/javascript" charset="utf-8" tal:content="string:var ${fieldname}_datatable;$$(document).ready(function() {${fieldname}_init_table();make_selectable(${fieldname}_datatable, '${fieldname}');make_editable(${fieldname}_datatable, '${fieldname}');} );">
        </script>
        <script type="text/javascript" charset="utf-8"
        tal:define="data python:options['field'].getSettings().tojson(v);
                    param python:options['field'].getSettings().getParameters();"
        tal:content="string:function ${fieldname}_init_table() {${fieldname}_datatable = $('#${fieldname}_datagrid').dataTable( {'aaData': ${data}, ${param} } ); }">
        </script>
        <table class="plain" tal:attributes="id string:${fieldname}_datagrid">
        </table>
        <p><a href="javascript:void(0);" tal:attributes="onclick string:fnClickAddRow(${fieldname}_datatable, '${fieldname}');">Click to add a new row</a></p>
        <p><a href="javascript:void(0)" tal:attributes="onclick string:fnDeleteAndUpdate(${fieldname}_datatable, '${fieldname}')" >Delete selected row</a></p>

</tal:block>
